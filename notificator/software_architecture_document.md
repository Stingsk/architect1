# Технический проект "Сервис отправки оповещений"

**Архитектор**: Станислав Волков / Название организации  
**Дата:** 10 Октября 2023


### История версий

> ***Опционально***  
> Отражает изменения, внесенные в документ, включая дату, версию, описание изменения и автора

|    Дата    | Автор | Что изменилось  | 
|:----------:| :-: |:---------------:|
| 10.10.2023 | Станислав Волков | Создан документ | 

### Краткий обзор

> Краткий обзор всей архитектуры решения. Должен предоставлять общее представление о целях проекта, ключевых особенностях, основных преимуществах, ожидаемых затратах и потенциальных рисках. Главным образом предназначено для лиц, принимающих решения, которые могут не углубляться в детальные разделы документа.

##### Название проекта: "Сервис отправки оповещений"

Требуется cистема отправки оповещений.
Проект "Сервис отправки оповещений" - это наш ответ на эти запросы.

##### Цель

Построить маштабируюемую высоко-производительную ситему по отправке оповещений в 3 канала (SMS, E-Mail, Push-уведомления).

##### КЛЮЧЕВЫЕ ОСОБЕННОСТИ

- ***ИСПОЛЬЗОВАНИЕ KAFKA:*** Обеспечиват демпфер по обработки пиков нагрузки и хранит запросы на отправку уведомлений в упорядоченном виде.
- ***STATELESS СЕРВИСЫ:*** Все сервисы не хранят данные, поэтому их удобно маштабировать.
- ***MICROSERVICE АРХИТЕКТУРА:*** Каждый бизнес процесс(Запрос на отправку, настройки, контроль настроек, отправка сообщений) выделен в отдельный сервис что позволяет маштабировать только те части системы которые испытываю нагрузку.
- ***ПРЕИМУЩЕСТВА:*** Повышение качества обслуживания клиентов, сокращение расходов на обслуживание клиентов, в следствие лучшего котроля работы системы.
- ***ОРИЕНТИРОВОЧНАЯ СТОИМОСТЬ:*** Общие инвестиции в этот переход оцениваются в $1 млн, с прогнозируемой окупаемостью инвестиций в 60% в течение следующих трех лет.
- ***РИСКИ:*** Возможные краткосрочные перебои во время перехода от устаревшей системы.

Проект "Сервис отправки оповещений" - это инвестиции в наше будущее, один из шагов по построению маштабируемой и высокопроизводительной системы

### Введение

> В этом разделе представлена ключевая терминология по архитектуре решения и границы проекта. Он разработан для того, чтобы все заинтересованные стороны имели общее понимание, и не было двусмысленностей в терминах или границах проекта.

### Ключевые термины, определения, аббревиатуры

> ***Опционально***  
> Представляет любую специализированную терминологию, сокращения или аббревиатуры, используемые в документе. Это помогает обеспечить ясность и понимание для всех заинтересованных сторон.

| Термин | Определение |
|:-:|:-|
| СУБД | Система управления базами данных |

### Границы проекта

> Четко определяет, что включено в проект, и, что не менее важно, что исключено. Это устанавливает четкие границы для целей проекта, результатов, функций и функциональных возможностей.

##### Включено:
- Отправка сообщений.
- Настроки отправки сообщений.
##### Исключено:
- Проверка авторизации.
- Разработка UI для настроек.

### Требования

Система представляет собой проект со следующими требованиями к бизнес-логике:

* *В части оповещений*:
    * отправка оповещений в 3 канала (SMS, E-Mail, Push-уведомления);
    * сообщений и их содержимого будут являться другие подсистемы, следовательно необходим подходящий способ взаимодействия с ними;
    * необходима возможность мультиплексирования (рассылки одного сообщения по всем каналам группе клиентов) так и адресной отправки в каждый канал связи конкретным адресатам;
    * учтитывать природу разных каналов связи, их потенциальные ограничения и пропускную способность (например, ограничение количества символов в СМС, стоимость СМС, лимиты пуш-очередей провайдеров, возможность попадания e-mail в спам и т.д.);
* *В части настроек*:
    * требуется принимать от пользователя системы настройки по каждому каналу связи для рассылки уведомлений (вкл/выкл, адрес/номер/логин) и учитывать эти настройки при последующих рассылках;
    * хранения пользовательских настроек необходимо предусмотреть хранилище, связанное с пользовательской информацией в других подсистемах;

#### Заинтересованные стороны

> Определяет и описывает основные группы или отдельных лиц, которые заинтересованы/участвуют в проекте, его результатах или затрагиваются его итогами. Важно понимать их потребности, опасения и влияние.

> [!NOTE]
>  - **Сторона:** Указывает на группу или категорию, к которой принадлежит заинтересованная сторона. Это может быть отдел, группа пользователей или внешняя организация.
>  - **Имя:** Если применимо, это было бы конкретное лицо, представляющее сторону-участника, особенно актуально для ключевых лиц, принимающих решения, или основных контактных лиц.
>  - **Роль/Должность:** Определяет основную функцию или отношение участника к проекту.
>  - **Интересы/Опасения:** Описывает конкретные интересы, риски или потребности, которые участник может иметь в отношении проекта.

|    Сторона    |       Имя        |  Роль/Должность  | Интересы/Опасения                                                  |
|:-------------:|:----------------:|:----------------:|:-------------------------------------------------------------------|
| Пользователи |  Полина Иванова  | Отдел разработки | Согласованные и подробно описанные требования                      |
| Пользователи  |   Иван Иванов    |     Клиенты      | Получение уведомлений в приемлемое время                           |

#### Функциональные требования

> Описывает конкретные функциональные возможности, которые система должна предоставлять в четких, выполнимых терминах.

> [!NOTE]
> - **Группа:** Категория или модуль, к которому принадлежит функциональное требование.
> - **ID:** Уникальный идентификатор для каждого требования. Это помогает в отслеживании, ссылке и управлении требованием на протяжении всего его жизненного цикла.
> - **Описание:** Четкое и подробное изложение требования, объясняющее, какая конкретная функциональность или поведение ожидается.
> - **Приоритет:** Определяет важность требования по отношению к другим требованиям. Обычно используются уровни **ВЫСОКИЙ**, **СРЕДНИЙ** и **НИЗКИЙ**. Другие шкалы, такие как **MOSCOW (ОБЯЗАТЕЛЬНО, ЖЕЛАТЕЛЬНО, ВОЗМОЖНО, НЕ ТРЕБУЕТСЯ)**, также могут быть использованы в зависимости от организационных предпочтений.

|                Группа                 |  ID  | Описание                                                                                                    | Приоритет |
|:-------------------------------------:|:----:|:------------------------------------------------------------------------------------------------------------| :-: |
|     Обработка запроса оповещения      | F001 | Возможность оправлять оповещения                                                                            | ВЫСОКИЙ |
|     Обработка запроса оповещения      | F002 | Можно отправлять одно оповещения нескольким пользователям                                                   | ВЫСОКИЙ |
|     Обработка запроса оповещения      | F003 | Можно отправлять одно оповещение в несколько каналов                                                        | СРЕДНИЙ |
|     Обработка запроса оповещения      | F004 | При не удаче отправки оповещения, отправлять повторно                                                       | СРЕДНИЙ |
|          Настроки оповещений          | F101 | Настроить включенные для пользователя каналы                                                                | СРЕДНИЙ |
|          Настроки оповещений          | F102 | Настроить e-mail адреса пользователя                                                                        | ВЫСОКИЙ |
|          Настроки оповещений          | F103 | Настроить номер телефона пользователя                                                                       | ВЫСОКИЙ |
|          Настроки оповещений          | F104 | Насторить логин для пуш уведомлений на устройства                                                           | ВЫСОКИЙ |
|          Настроки оповещений          | F105 | Настрока  шаблона e-mail                                                                                    | СРЕДНИЙ |
|          Настроки оповещений          | F106 | Настрока  длины и действий при длинном смс (рабивать ли?)                                                   | ВЫСОКИЙ |
|          Настроки оповещений          | F107 | Настрока  максимальной длины push уведомления                                                               | ВЫСОКИЙ |
|          Настроки оповещений          | F108 | Настройка лимита сообщений пользователю по каналу и общего                                                  | СРЕДНИЙ |
|          Настроки оповещений          | F109 | Настройка лимита канала поставщика услуг                                                                    | ВЫСОКИЙ |
|           Контроль лиммитов           | F201 | Проверять выдавать ошибку если при запросе сообщение превышает лимит символов в котором его хотят отправить | ВЫСОКИЙ |
|           Контроль лиммитов           | F202 | Контролировать лимиты на отсылку сообщений пользователю                                                     | СРЕДНИЙ |
|           Контроль лиммитов           | F203 | Контролировать лимиты на отсылку сообщений поставщику канала                                                | ВЫСОКИЙ |


#### Нефункциональные требования

> Охватывает качество или критерии функционирования системы, такие как производительность, масштабируемость и безопасность.

> [!NOTE]
> - **Группа:** Категория или атрибут качества, к которому принадлежит нефункциональное требование ([список общих атрибутов качества для использования:](https://en.wikipedia.org/wiki/List_of_system_quality_attributes))
> - **ID:** Уникальный идентификатор для каждого требования.
> - **Описание:** Четкое и подробное изложение требования.
> - **Приоритет:** Определяет важность требования по отношению к другим требованиям. Обычно используются уровни **ВЫСОКИЙ**, **СРЕДНИЙ** и **НИЗКИЙ**. Другие шкалы, такие как **MOSCOW (ОБЯЗАТЕЛЬНО, ЖЕЛАТЕЛЬНО, ВОЗМОЖНО, НЕ ТРЕБУЕТСЯ)**, также могут быть использованы в зависимости от организационных предпочтений.

|       Группа       | ID | Описание                                            | Приоритет |
|:------------------:| :-: |:----------------------------------------------------|:---------:|
|    Безопасность    | U001 | Проверять токен авторизации в AuthenticationService |  Высокий  |
| Производительность | U101 | Требования к нагрузке 1000 RPS                      |  Высокий  |
|  Масштабируемость  | U201 | Иметь возможность горизонтально маштабироваться     |  Высокий  |
|     Интерагция     | U301 | Писать логи в Elastic                               |  Высокий   |

#### Ограничения

> Перечисляются ограничения, в рамках которых должна работать команда проекта, такие как технологические, финансовые или временные ограничения.

> [!NOTE]
> - **Тип:** Категория или характер ограничения, например: техническое, финансовое, временное и т. д.
> - **ID:** Уникальный идентификатор для каждого ограничения
> - **Описание:** Четкое и подробное описание ограничения.

| Тип |  ID  | Описание                                                                 |
| :-: |:----:|:-------------------------------------------------------------------------|
| Сроки   | R001 | 2 месяца на разработку                                                   |
| Ресурсы | R101 | 1280  человеко-часов на разработку                                       |
| Границы проекта | R201 | Авторизация по токену, проверяем во внешней системе                      |
| Границы проекта | R202 | Пишем логи в ELK стек, так же как в других компонентах                   |
| Границы проекта | R203 | Контролом попадания в спам занимается внешний поставщик e-mail рассылок  |

#### Предположения

> Документируются все предполагаемые факты или условия, которые будут влиять на решения проекта. Они часто служат основой для рисков, так как предположения часто включают в себя некоторую степень неопределенности.

> [!NOTE]
> - **ID:** Уникальный идентификатор для каждого предположения для легкого его учета.
> - **Описание:** Четкое и краткое изложение предположения.

|  ID  | Описание                                                                                          |
|:----:|:--------------------------------------------------------------------------------------------------|
| A001 | Есть сильные сезонные колебания, нужно учесть возможность гибкого маштабирования                  |
| A002 | Существующая IT-команда обладает необходимыми навыками для поддержки и обслуживания новой системы |

---

## Текущая архитектура

В текущей архитектуре у нас есть мобильное приложение, которое общается с компонентом "Controller", а он в свою очередь делает запросы к "Foo" и "Bar".

![alt text](static/current_arch.svg)


## Целевая архитектура
### Диаграмма контекста (C1):
![C1](static/c1.svg)

Предполагается, что любой из существующих компонентов может отправить оповещение пользователю. При этом существующие каналы связи и предпочтения по их использованию известны системе оповещений, компоненты остальной системы знать это не должны.

### Диаграмма контекста (C2):
Результаты встреч перед C2
* [Получение запроса и хранение настроек](adr_1.md)
* [Выбор способа и места хранение сообщений и контроля лимитов](adr_2.md)
* [Обсуждение отправки сообщений](adr_3.md)
* [Уточнение архитектуры отправки сообщений](adr_4.md)

![С2](/static/c2.png)

### Диаграмма контекста (C3):

Результаты встреч перед C3
* [Обсуждение архитектуры NotificationService](adr_5.md)

![С3](/static/c3.png)

Результаты последующих встреч
* [Выбор протокола взаимодействия](adr_6.md)


### Оценка прототипа

Шаги оценки прототипа 

* *Производительность*:
  * оценить нагрузку(1000 rps) и время до отпраки;
  * оценить время до отпраки при увеличении нагрузки(10000 rps);
  * проверить работу маштабирования в системе k8s;
  * полноту мониторинга и логирования, а так же работу при нештатных ситуациях;
* *Соотвествие требованиям*:
  * проверить обратную связь от клиентов;
  * собрать обратную связь от разработчиков;
  * собрать обратную связь от группы поддержки;
  * собрать обратную связь от бизнеса;
